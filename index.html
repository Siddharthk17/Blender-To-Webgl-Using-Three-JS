<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Station</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; }
        
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            transition: opacity 0.8s ease;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #0088ff; border-radius: 50%;
            animation: spin 1s infinite linear; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #status { color: #888; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="status">Loading...</div>
    </div>
    <div id="canvas-container"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        class SpaceStationViewer {
            constructor() {
                this.container = document.getElementById('canvas-container');
                this.init();
            }

            init() {
                // 1. Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000000); 

                // 2. Camera
                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(8, 5, 8);

                // 3. Renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.toneMappingExposure = 0.8; // Lower exposure to prevent white-out
                this.container.appendChild(this.renderer.domElement);

                // 4. Environment
                const pmremGenerator = new THREE.PMREMGenerator(this.renderer);
                this.scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

                // 5. Post Processing (Bloom)
                this.composer = new EffectComposer(this.renderer);
                this.composer.addPass(new RenderPass(this.scene, this.camera));

                const bloomPass = new UnrealBloomPass(
                    new THREE.Vector2(window.innerWidth, window.innerHeight),
                    1.5,  // Strength
                    0.4,  // Radius
                    0.75  // Threshold 
                );
                this.composer.addPass(bloomPass);
                this.composer.addPass(new OutputPass());

                // 6. Lights
                const blueLight = new THREE.DirectionalLight(0x0066ff, 1.0); // intensity
                blueLight.position.set(-5, 10, -5);
                this.scene.add(blueLight);
                
                // Main Sun
                const sunLight = new THREE.DirectionalLight(0xffffff, 0.5); 
                sunLight.position.set(10, 5, 10);
                this.scene.add(sunLight);

                // 7. Controls
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.autoRotate = true;
                this.controls.autoRotateSpeed = 0.5;

                this.loadModel();
                window.addEventListener('resize', this.onResize.bind(this));
                this.animate();
            }

            loadModel() {
                const loader = new GLTFLoader();
                
                loader.load('space_station.glb', (gltf) => {
                    this.model = gltf.scene;

                    this.model.traverse((child) => {
                        if (child.isMesh && child.material) {
                            
                            const m = child.material;
                            
                            if (m.metalness > 0.5 && m.roughness < 0.2) {
                                m.roughness = 0.35; // Brushed Metal look
                            }

                            // 2. Handle Lights
                            const color = m.color || new THREE.Color(0,0,0);
                            const emissive = m.emissive || new THREE.Color(0,0,0);
                            
                            const isBlueColor = (color.b > color.r && color.b > color.g) || (emissive.b > emissive.r && emissive.b > emissive.g);
                            const isBlueName = m.name.toLowerCase().includes('blue') || m.name.toLowerCase().includes('glass');
                            
                            if (isBlueColor || isBlueName) {
                                // Force Blue Glow
                                if (emissive.r === 0 && emissive.g === 0 && emissive.b === 0) {
                                    m.emissive = color.clone();
                                }
                                if (m.emissive.b < 0.2) m.emissive.setHex(0x0044ff);

                                // High intensity to overcome the high Bloom Threshold
                                m.emissiveIntensity = 10.0; 
                                m.toneMapped = false;
                            } 
                            else {
                                // Dim other lights
                                m.emissiveIntensity = 1.0;
                            }

                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });

                    // Center and Scale
                    const box = new THREE.Box3().setFromObject(this.model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 6 / maxDim;
                    
                    this.model.scale.set(scale, scale, scale);
                    this.model.position.sub(center.multiplyScalar(scale));
                    
                    this.scene.add(this.model);

                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 800);

                }, undefined, (err) => {
                    console.error(err);
                });
            }

            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.composer.setSize(window.innerWidth, window.innerHeight);
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                this.controls.update();
                this.composer.render();
            }
        }

        new SpaceStationViewer();
    </script>
</body>
</html>
